name: Daily Scraper & AI Prediction

on:
  schedule:
    # 4D: Wed, Sat, Sun at 7:15 PM SGT (11:15 UTC)
    - cron: '15 11 * * 0,3,6'
    
    # Toto: Mon, Thu at 10:15 PM SGT (14:15 UTC) - Safety buffer for late draws
    - cron: '15 14 * * 1,4'
  workflow_dispatch:  # Allow manual trigger

jobs:
  scrape-and-predict:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Chrome
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium webdriver-manager beautifulsoup4 google-generativeai python-dotenv

    - name: Fetch DB via SCP
      run: |
        mkdir -p .tmp
        echo "${{ secrets.ORACLE_SSH_KEY }}" > /tmp/ssh_key
        chmod 600 /tmp/ssh_key
        scp -o StrictHostKeyChecking=no -i /tmp/ssh_key \
          ubuntu@${{ secrets.ORACLE_HOST }}:/home/ubuntu/Singaporepools/.tmp/singapore_pools.db \
          .tmp/singapore_pools.db 2>/dev/null || echo "‚ö†Ô∏è No existing DB found, starting fresh"
        rm -f /tmp/ssh_key
        ls -la .tmp/ || true

    - name: Run Scrapers (Headless)
      run: |
        # Ensure .tmp exists
        mkdir -p .tmp
        
        # Run 4D Scraper
        echo "üé≤ Running 4D Scraper..."
        python execution/scrape_4d.py --limit 5 || echo "‚ö†Ô∏è 4D scraper had issues"
        
        # Run Toto Scraper
        echo "üé∞ Running Toto Scraper..."
        python execution/scrape_toto.py --limit 5 || echo "‚ö†Ô∏è Toto scraper had issues"
        
        # Show what was created
        echo "üìÅ Contents of .tmp/:"
        ls -la .tmp/

    - name: Run AI Predictor
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        python execution/ai_predictor.py --game both
        echo "üìÅ Final .tmp/ contents:"
        ls -la .tmp/

    - name: Verify files exist before upload
      id: verify
      run: |
        if [ -f ".tmp/singapore_pools.db" ]; then
          echo "‚úÖ Database file exists"
          echo "db_exists=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Database file NOT found!"
          echo "db_exists=false" >> $GITHUB_OUTPUT
        fi
        
        if [ -f ".tmp/ai_predictions.json" ]; then
          echo "‚úÖ Predictions file exists"
          echo "predictions_exist=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Predictions file NOT found!"
          echo "predictions_exist=false" >> $GITHUB_OUTPUT
        fi

    - name: Upload Data to Server via SCP
      if: steps.verify.outputs.db_exists == 'true' || steps.verify.outputs.predictions_exist == 'true'
      run: |
        echo "${{ secrets.ORACLE_SSH_KEY }}" > /tmp/ssh_key
        chmod 600 /tmp/ssh_key
        
        # Upload each file individually
        if [ -f ".tmp/singapore_pools.db" ]; then
          echo "üì§ Uploading database..."
          scp -o StrictHostKeyChecking=no -i /tmp/ssh_key \
            .tmp/singapore_pools.db \
            ubuntu@${{ secrets.ORACLE_HOST }}:/home/ubuntu/Singaporepools/.tmp/
        fi
        
        if [ -f ".tmp/ai_predictions.json" ]; then
          echo "üì§ Uploading predictions..."
          scp -o StrictHostKeyChecking=no -i /tmp/ssh_key \
            .tmp/ai_predictions.json \
            ubuntu@${{ secrets.ORACLE_HOST }}:/home/ubuntu/Singaporepools/.tmp/
        fi
        
        rm -f /tmp/ssh_key
        echo "‚úÖ Upload complete!"

    - name: Skip upload (no files)
      if: steps.verify.outputs.db_exists != 'true' && steps.verify.outputs.predictions_exist != 'true'
      run: |
        echo "‚ö†Ô∏è No files to upload - check scraper logs above for errors"
        exit 1
