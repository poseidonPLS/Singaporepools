name: Daily Scraper & AI Prediction

on:
  schedule:
    # 4D: Wed, Sat, Sun at 7:15 PM SGT (11:15 UTC)
    - cron: '15 11 * * 0,3,6'
    
    # Toto: Mon, Thu at 10:15 PM SGT (14:15 UTC) - Safety buffer for late draws
    - cron: '15 14 * * 1,4'
  workflow_dispatch:  # Allow manual trigger

jobs:
  scrape-and-predict:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium webdriver-manager beautifulsoup4 google-generativeai python-dotenv

    - name: Download existing DB from Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.ORACLE_HOST }}
        username: ubuntu
        key: ${{ secrets.ORACLE_SSH_KEY }}
        script: |
          cat /home/ubuntu/Singaporepools/.tmp/singapore_pools.db 2>/dev/null || echo "NO_DB_EXISTS"
      continue-on-error: true

    - name: Fetch DB via SCP
      run: |
        mkdir -p .tmp
        echo "${{ secrets.ORACLE_SSH_KEY }}" > /tmp/ssh_key
        chmod 600 /tmp/ssh_key
        scp -o StrictHostKeyChecking=no -i /tmp/ssh_key ubuntu@${{ secrets.ORACLE_HOST }}:/home/ubuntu/Singaporepools/.tmp/singapore_pools.db .tmp/ || echo "No existing DB found, starting fresh"
        rm /tmp/ssh_key

    - name: Run Scrapers (Headless)
      run: |
        # Ensure .tmp exists (if download failed or first run)
        mkdir -p .tmp
        
        # Run 4D Scraper
        python execution/scrape_4d.py --limit 5
        
        # Run Toto Scraper
        python execution/scrape_toto.py --limit 5

    - name: Run AI Predictor
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        python execution/ai_predictor.py --game both

    - name: Upload Data to Server via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.ORACLE_HOST }}
        username: ubuntu
        key: ${{ secrets.ORACLE_SSH_KEY }}
        source: ".tmp/*"
        target: "/home/ubuntu/Singaporepools/.tmp"
        strip_components: 1
